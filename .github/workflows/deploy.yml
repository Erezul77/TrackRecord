name: Deploy to DigitalOcean

# Runs on every push to main branch
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to DigitalOcean Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            cd ~/TrackRecord
            
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main
            
            echo "ðŸ›‘ Stopping old containers..."
            docker stop trackrecord-api || true
            docker rm trackrecord-api || true
            docker stop trackrecord-worker || true
            docker rm trackrecord-worker || true
            
            echo "ðŸ”¨ Building API image..."
            docker build -t trackrecord-api ./backend
            
            echo "ðŸ”¨ Building Worker image..."
            docker build -t trackrecord-worker -f ./backend/Dockerfile.worker ./backend
            
            echo "ðŸš€ Starting API container..."
            docker run -d \
              --name trackrecord-api \
              -p 8000:8000 \
              --env-file backend/.env \
              -e GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
              -e GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              -e ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}" \
              --restart unless-stopped \
              trackrecord-api
            
            echo "ðŸš€ Starting Worker container..."
            docker run -d \
              --name trackrecord-worker \
              --env-file backend/.env \
              -e ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}" \
              -e RSS_INTERVAL_MINUTES=180 \
              -e RESOLUTION_INTERVAL_MINUTES=240 \
              -e HISTORICAL_ENABLED=true \
              --restart unless-stopped \
              trackrecord-worker
            
            echo "âœ… Deployment complete!"
            
            # Show container status
            echo "Running containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
