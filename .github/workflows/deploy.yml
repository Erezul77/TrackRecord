name: Deploy to DigitalOcean

# Runs on every push to main branch
on:
  push:
    branches:
      - main

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    name: Deploy API
    
    steps:
      - name: Deploy API to Main Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            cd ~/TrackRecord
            
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main
            
            echo "ðŸ›‘ Stopping old API container..."
            docker stop trackrecord-api || true
            docker rm trackrecord-api || true
            
            echo "ðŸ”¨ Building API image..."
            docker build -t trackrecord-api ./backend
            
            echo "ðŸš€ Starting API container..."
            docker run -d \
              --name trackrecord-api \
              -p 8000:8000 \
              --env-file backend/.env \
              -e GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
              -e GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              -e ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}" \
              --restart unless-stopped \
              trackrecord-api
            
            echo "âœ… API Deployment complete!"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

  deploy-worker:
    runs-on: ubuntu-latest
    name: Deploy Worker
    needs: deploy-api  # Wait for API to deploy first
    
    steps:
      - name: Deploy Worker to Same Server as API
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            cd ~/TrackRecord
            
            echo "ðŸ“¥ Code already pulled by API deployment..."
            
            echo "ðŸ›‘ Stopping old worker..."
            docker stop trackrecord-worker || true
            docker rm trackrecord-worker || true
            
            echo "ðŸ”¨ Building Worker image..."
            docker build -t trackrecord-worker -f ./backend/Dockerfile.worker ./backend
            
            echo "ðŸš€ Starting Worker container..."
            docker run -d \
              --name trackrecord-worker \
              --env-file backend/.env \
              -e ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}" \
              -e RSS_INTERVAL_MINUTES=180 \
              -e RESOLUTION_INTERVAL_MINUTES=60 \
              -e HISTORICAL_ENABLED=true \
              --restart unless-stopped \
              trackrecord-worker
            
            echo "âœ… Worker Deployment complete!"
            echo ""
            echo "ðŸ“Š All containers running:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
